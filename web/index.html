<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Heritage Sites Finder</title>
        <style>
            body {
                font-family: system-ui, -apple-system, Segoe UI, Roboto,
                    sans-serif;
                padding: 1rem;
            }
            input[type="text"] {
                width: 60%;
                padding: 0.5rem;
            }
            button {
                padding: 0.5rem 1rem;
            }
            .result {
                margin: 0.5rem 0;
                padding: 0.5rem;
                border-bottom: 1px solid #ddd;
            }
            .score {
                color: #666;
                font-size: 0.9rem;
            }
            .spinner {
                display: inline-block;
                width: 16px;
                height: 16px;
                border: 2px solid #ccc;
                border-top-color: #333;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-left: 8px;
                vertical-align: middle;
            }
            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }
                to {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>
    <body>
        <h1>Heritage Sites Finder</h1>
        <p>Search UNESCO World Heritage sites (demo)</p>
        <div>
            <input id="q" type="text" placeholder="e.g. temple ruins" />
            <label for="k">Results:</label>
            <select id="k">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="20">20</option>
                <option value="50">50</option>
            </select>
            <button id="go">Search</button>
            <span
                id="spinner"
                class="spinner"
                style="display: none"
                aria-hidden="true"
            ></span>
        </div>
        <div id="results"></div>

        <script>
            // Helpers for UI state
            const btn = document.getElementById("go");
            const qInput = document.getElementById("q");
            const kSelect = document.getElementById("k");
            const spinner = document.getElementById("spinner");

            function setLoading(loading) {
                btn.disabled = loading;
                qInput.disabled = loading;
                kSelect.disabled = loading;
                spinner.style.display = loading ? "inline-block" : "none";
                btn.textContent = loading ? "Searchingâ€¦" : "Search";
            }

            // Persist k (results count) in localStorage so user's choice is remembered
            const STORAGE_KEY = "hsf:k";
            (function restoreK() {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) kSelect.value = saved;
                } catch (e) {
                    // ignore if localStorage inaccessible
                }
            })();
            kSelect.addEventListener("change", () => {
                try {
                    localStorage.setItem(STORAGE_KEY, kSelect.value);
                } catch (e) {
                    // ignore quota / privacy mode errors
                }
            });

            async function search(q, k) {
                setLoading(true);
                try {
                    const res = await fetch(
                        `/search?q=${encodeURIComponent(
                            q
                        )}&k=${encodeURIComponent(k)}`
                    );
                    if (!res.ok) {
                        const err = await res
                            .json()
                            .catch(() => ({ error: res.statusText }));
                        document.getElementById("results").innerText =
                            "Error: " + (err.error || res.statusText);
                        return;
                    }
                    const data = await res.json();
                    const el = document.getElementById("results");
                    el.innerHTML = "";
                    if (!Array.isArray(data) || data.length === 0) {
                        el.innerText = "No results";
                        return;
                    }
                    for (const r of data) {
                        const d = document.createElement("div");
                        d.className = "result";
                        d.innerHTML = `<div><strong>${
                            r.name
                        }</strong> <span class="score">[${r.score.toFixed(
                            4
                        )}]</span></div><div>${r.country || ""}</div><div>${
                            r.description || ""
                        }</div>`;
                        el.appendChild(d);
                    }
                } catch (err) {
                    document.getElementById("results").innerText =
                        "Error: " +
                        (err && err.message ? err.message : String(err));
                } finally {
                    setLoading(false);
                }
            }

            btn.addEventListener("click", () => {
                const q = qInput.value.trim();
                const k = parseInt(kSelect.value || "10", 10);
                if (q) search(q, k);
            });

            qInput.addEventListener("keydown", (e) => {
                if (e.key === "Enter") btn.click();
            });

            // allow changing k via keyboard (Enter will trigger search)
            kSelect.addEventListener("keydown", (e) => {
                if (e.key === "Enter") btn.click();
            });
        </script>
    </body>
</html>
