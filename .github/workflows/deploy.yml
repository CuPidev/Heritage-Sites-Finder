name: Deploy to VPS

on:
    push:
        branches: [main]

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up SSH
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa
                  ssh-keyscan -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts
              env:
                  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
                  DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}

            - name: Rsync project to VPS
              run: |
                  rsync -avz --delete --exclude='.git' --exclude='.venv' --exclude='data' ./ "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}"

            - name: Remote setup and restart
              run: |
                  ssh "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" "bash -l -c 'set -euo pipefail; cd "${{ secrets.DEPLOY_PATH }}"; if [ ! -d .venv ]; then python3 -m venv .venv; fi; . .venv/bin/activate; pip install --upgrade pip; pip install -r requirements.txt; sudo systemctl restart heritage'"

            - name: Done
              run: echo "Deployment to ${{ secrets.DEPLOY_HOST }} completed."
